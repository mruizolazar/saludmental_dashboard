{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Salud Mental</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js + zoom + annotation -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>

  <style>
    :root{
      --h-card-charts: 520px;
      --h-card-evol:   560px;
      --pie-min:       360px;
    }
    body{ background:#f5f7fb; }
    .kpi-card{border-left:4px solid #0d6efd;border-radius:.75rem;box-shadow:0 3px 10px rgba(0,0,0,.06)}
    .kpi-card .kpi-num{font-size:2rem;font-weight:700;color:#0d6efd}
    .kpi-warning{border-left-color:#f59f00}.kpi-warning .kpi-num{color:#f59f00}
    .kpi-danger{border-left-color:#e03131}.kpi-danger .kpi-num{color:#e03131}
    .kpi-success{border-left-color:#2f9e44}.kpi-success .kpi-num{color:#2f9e44}
    .card{border:0;border-radius:1rem;box-shadow:0 6px 18px rgba(0,0,0,.06)}

    .chart-box{height:var(--h-card-charts)}
    .evol-box{height:var(--h-card-evol); overflow:visible;}

    /* pie siempre circular y centrado */
    .square-wrap{display:grid;place-items:center;height:100%;width:100%;}
    .square-wrap canvas{
      width:100%;max-width:720px;aspect-ratio:1/1;height:auto;min-height:var(--pie-min);
    }

    @media (max-width: 992px){
      :root{ --h-card-charts: 420px; --h-card-evol: 520px; --pie-min:300px; }
    }
    .legend-note{font-size:.8rem;color:#6c757d}
  </style>
</head>
<body class="text-dark">

<div class="container py-4">
  <div class="d-flex align-items-center gap-2 mb-3">
    <span style="font-size:1.9rem">üß†</span>
    <h1 class="m-0 fw-bold">Dashboard del Centro de Salud Mental</h1>
  </div>

  <!-- Filtros -->
  <form method="get" class="row g-3 align-items-end mb-3">
    <div class="col-md-2">
      <label class="form-label">Sexo</label>
      <select name="sexo" class="form-select">
        <option value="" {% if not filtro_sexo %}selected{% endif %}>Todos</option>
        <option value="Femenino" {% if filtro_sexo == "Femenino" %}selected{% endif %}>Femenino</option>
        <option value="Masculino" {% if filtro_sexo == "Masculino" %}selected{% endif %}>Masculino</option>
        <option value="Otro" {% if filtro_sexo == "Otro" %}selected{% endif %}>Otro</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Desde</label>
      <input type="date" name="desde" class="form-control" value="{{ filtro_desde }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Hasta</label>
      <input type="date" name="hasta" class="form-control" value="{{ filtro_hasta }}">
    </div>
    <div class="col-md-3">
      <label class="form-label">Prontuario</label>
      <input list="lista_prontuarios" name="prontuario" class="form-control" placeholder="Buscar prontuario..." value="{{ filtro_prontuario }}">
      <datalist id="lista_prontuarios">
        {% for nro in todos_los_prontuarios %}
          <option value="{{ nro }}"></option>
        {% endfor %}
      </datalist>
    </div>
    <div class="col-md-1 d-flex gap-2">
      <button type="submit" class="btn btn-primary w-100">Aplicar</button>
      <a href="{% url 'dashboard' %}" class="btn btn-secondary w-100">Limpiar</a>
    </div>
  </form>

  <!-- KPIs -->
  <div class="row g-3 mb-3">
    <div class="col-md-3">
      <div class="card p-3 kpi-card kpi-success text-center">
        <div class="text-muted">Total de Pacientes</div>
        <div class="kpi-num">{{ pacientes_count }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 kpi-card text-center">
        <div class="text-muted">Total de Consultas</div>
        <div class="kpi-num">{{ consultas_count }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 kpi-card kpi-warning text-center">
        <div class="text-muted">Ansiedad / P√°nico</div>
        <div class="kpi-num">{{ ansiedad_count }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card p-3 kpi-card kpi-danger text-center">
        <div class="text-muted">Depresi√≥n</div>
        <div class="kpi-num">{{ depresion_count }}</div>
      </div>
    </div>
  </div>

  <!-- Charts fila 1 -->
  <div class="row g-3 mb-3">
    <div class="col-lg-6">
      <div class="card p-3">
        <h5 class="mb-2 text-center">Pacientes por Sexo</h5>
        <div class="chart-box">
          <div class="square-wrap">
            <canvas id="sexoChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card p-3">
        <h5 class="mb-2 text-center">Diagn√≥sticos m√°s Comunes</h5>
        <div class="chart-box">
          <canvas id="diagnosticosChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Evoluci√≥n -->
  <div class="card p-3 mb-4">
    <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
      <h5 class="m-0">Evoluci√≥n del Riesgo del Paciente</h5>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <span class="text-muted">Paciente:</span>
          <select id="selectPaciente" class="form-select" style="min-width:260px">
            {% for p in pacientes_map %}
              <option value="{{ p.paciente_id }}" {% if p.paciente_id == initial_paciente_id %}selected{% endif %}>
                {{ p.numero_historia }} (ID {{ p.paciente_id }})
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="d-flex align-items-center gap-2">
          <span class="text-muted">Medicamento:</span>
          <select id="selectMed" class="form-select" style="min-width:220px">
            <option value="">Todos</option>
            {% if med_list %}
              {% for m in med_list %}
                <option value="{{ m }}">{{ m }}</option>
              {% endfor %}
            {% else %}
              <option value="" disabled>(Sin medicamentos en el filtro actual)</option>
            {% endif %}
          </select>
          <button id="btnMedClear" type="button" class="btn btn-outline-secondary btn-sm">Limpiar med</button>
        </div>

        <button id="btnEvolReset" type="button" class="btn btn-outline-secondary btn-sm">Reset zoom</button>
      </div>
    </div>

    <div class="evol-box mt-3">
      <canvas id="evolPaciente"></canvas>
    </div>
    <div id="evolMsg" class="pt-2 text-muted small"></div>
    <div class="legend-note mt-2">
      <span class="me-3">üü¶ Riesgo (0=POS, 1=NEU, 2=NEG)</span>
      <span class="me-3">‚úö Eventos NEG</span>
    </div>
  </div>
</div>

<!-- ===================== JS ===================== -->
<script>
  const SEXO_LABELS = {{ sexo_labels|safe }};
  const SEXO_DATA   = {{ sexo_data|safe }};
  const DIAG_LABELS = {{ diag_labels|safe }};
  const DIAG_DATA   = {{ diag_data|safe }};
</script>

<script>
  // ===== CHARTS SIMPLES =====
  (function(){
    const ctx1 = document.getElementById('sexoChart');
    if (ctx1) {
      new Chart(ctx1, {
        type: 'pie',
        data: {
          labels: SEXO_LABELS,
          datasets: [{
            data: SEXO_DATA,
            backgroundColor: ['#74c0fc','#63e6be','#ffd43b'],
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          animation:{ animateScale:true, duration:300 },
          layout: { padding: 8 },
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    const ctx2 = document.getElementById('diagnosticosChart');
    if (ctx2) {
      new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: DIAG_LABELS,
          datasets: [{
            label: 'Frecuencia',
            data: DIAG_DATA,
            backgroundColor: '#339af0',
            borderRadius: 6,
            maxBarThickness: 80
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          layout: { padding: { top:8, right:12, bottom:8, left:12 } },
          plugins: { legend: { display:false } },
          scales: {
            y: { beginAtZero:true },
            x: { ticks: { autoSkip: true } }
          }
        }
      });
    }
  })();
</script>

<script>
  // ====== Gr√°fico de evoluci√≥n (solo l√≠nea azul + eventos) ======
  function riesgoPointStyle(v){ return v===2?'cross':(v===1?'circle':'rectRounded'); }
  function riesgoPointColor(v){
    if (v===2) return 'rgba(231,76,60,1)';
    if (v===1) return 'rgba(241,196,15,1)';
    return 'rgba(52,152,219,1)';
  }

  async function dibujarEvolucion(pacienteId) {
    const desdeInput = document.querySelector('input[name="desde"]')?.value || null;
    const hastaInput = document.querySelector('input[name="hasta"]')?.value || null;
    const medSel = document.getElementById('selectMed')?.value || '';

    const url = new URL(`/api/pacientes/${pacienteId}/evolucion/`, window.location.origin);
    if (desdeInput) url.searchParams.set('desde', desdeInput);
    if (hastaInput) url.searchParams.set('hasta', hastaInput);
    if (medSel)     url.searchParams.set('med', medSel);

    const res = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const { labels, riesgo, meds, slope, desistio } = data;

    const msg = document.getElementById('evolMsg');
    const sTxt = (slope === null || slope === undefined) ? 'N/A' : slope.toFixed(3);
    let extra = desistio ? ' ‚Äî Desisti√≥ (>60 d√≠as sin consulta)' : '';
    msg.textContent = `Tendencia (pendiente): ${sTxt} ‚Üí <0 mejora | =0 estable | >0 empeora${extra}`;

    const negMarkers  = riesgo.map(v => (v === 2 ? 2 : null));
    const pointColors = riesgo.map(r => riesgoPointColor(r));
    const pointStyles = riesgo.map(r => riesgoPointStyle(r));

    if (window._evolChart) window._evolChart.destroy();

    const ctx = document.getElementById('evolPaciente').getContext('2d');
    window._evolChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'Riesgo (0 POS / 1 NEU / 2 NEG)',
            data: riesgo,
            borderColor: 'rgba(52,152,219,1)',
            backgroundColor: 'rgba(52,152,219,0.10)',
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: pointColors,
            pointBorderColor: pointColors,
            pointStyle: pointStyles,
            tension: 0,
            spanGaps: true,
            fill: false,
            clip: false
          },
          {
            label: 'Eventos NEG',
            data: negMarkers,
            borderColor: 'rgba(231,76,60,1)',
            backgroundColor: 'rgba(231,76,60,1)',
            pointStyle: 'cross',
            showLine: false,
            pointRadius: 5,
            pointHoverRadius: 6,
            clip: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        normalized: true,
        interaction: { mode: 'nearest', intersect: false },
        layout: { padding: { top: 8, right: 28, bottom: 8, left: 12 } },
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: (item) => `Riesgo: ${item.parsed.y}`,
              afterBody: (items) => {
                const idx = items?.[0]?.dataIndex ?? -1;
                if (idx < 0 || !Array.isArray(meds[idx])) return '';
                const lista = meds[idx].slice(0, 8).join(', ');
                return lista ? `\nüíä ${lista}` : '';
              }
            }
          },
          zoom: {
            pan:  { enabled: true, mode: 'x' },
            zoom: { wheel:{enabled:true}, pinch:{enabled:true}, mode:'x' }
          },
          annotation: { annotations: {} }
        },
        scales: {
          y: {
            min: -0.2, max: 2.2,
            grace: '5%',
            grid: { color: 'rgba(0,0,0,0.06)' },
            ticks: {
              stepSize: 1,
              callback: v => v===0?'POS (bajo)':(v===1?'NEU (medio)':(v===2?'NEG (alto)':''))
            }
          },
          x: {
            offset: true,
            grace: '5%',
            grid: { color: 'rgba(0,0,0,0.05)' },
            ticks: { autoSkip: true, maxRotation: 0 }
          }
        }
      }
    });

    if (desistio && labels.length) {
      window._evolChart.options.plugins.annotation.annotations['desist'] = {
        type: 'label',
        xValue: labels[labels.length - 1],
        yValue: 2.05,
        content: ['Desisti√≥', '(>60 d√≠as sin consulta)'],
        backgroundColor: 'rgba(0,0,0,0.75)',
        color: '#fff',
        padding: 6,
        borderRadius: 6
      };
      window._evolChart.update();
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    const sel = document.getElementById('selectPaciente');
    const btnReset = document.getElementById('btnEvolReset');
    const desde = document.querySelector('input[name="desde"]');
    const hasta = document.querySelector('input[name="hasta"]');
    const selMed = document.getElementById('selectMed');
    const btnMedClear = document.getElementById('btnMedClear');

    const cargar = () => {
      const id = sel?.value;
      if (!id) return;
      dibujarEvolucion(id).catch(e => {
        console.error(e);
        const msg = document.getElementById('evolMsg');
        if (msg) msg.textContent = `No se pudo cargar el gr√°fico: ${e.message}`;
      });
    };

    sel?.addEventListener('change', cargar);
    desde?.addEventListener('change', cargar);
    hasta?.addEventListener('change', cargar);
    selMed?.addEventListener('change', cargar);
    btnMedClear?.addEventListener('click', () => { selMed.value=''; cargar(); });
    btnReset?.addEventListener('click', () => { try { window._evolChart.resetZoom(); } catch(_){} });

    // primera carga
    cargar();
  });
</script>

</body>
</html>
