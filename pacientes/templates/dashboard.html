{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <title>Dashboard Salud Mental</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}" />
</head>
<body class="bg-light text-dark">

<div class="container py-4">
    <h1 class="mb-4 text-center">🧠 Dashboard del Centro de Salud Mental</h1>

    <!-- Filtros -->
    <form method="get" class="row g-3 mb-4 align-items-end">
        <div class="col-md-2">
            <label class="form-label">Sexo</label>
            <select name="sexo" class="form-select">
                <option value="" {% if not filtro_sexo %}selected{% endif %}>Todos</option>
                <option value="Femenino" {% if filtro_sexo == "Femenino" %}selected{% endif %}>Femenino</option>
                <option value="Masculino" {% if filtro_sexo == "Masculino" %}selected{% endif %}>Masculino</option>
                <option value="Otro" {% if filtro_sexo == "Otro" %}selected{% endif %}>Otro</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="form-label">Desde</label>
            <input type="date" name="desde" class="form-control" value="{{ filtro_desde }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">Hasta</label>
            <input type="date" name="hasta" class="form-control" value="{{ filtro_hasta }}">
        </div>
        <div class="col-md-3">
            <label class="form-label">Prontuario</label>
            <input list="lista_prontuarios" name="prontuario" class="form-control" placeholder="Buscar prontuario..." value="{{ filtro_prontuario }}">
            <datalist id="lista_prontuarios">
                {% for nro in todos_los_prontuarios %}
                    <option value="{{ nro }}"></option>
                {% endfor %}
            </datalist>
        </div>
        <div class="col-md-1 d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-grow-1">Aplicar</button>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary flex-grow-1">Limpiar</a>
        </div>
    </form>

    <!-- Indicadores -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card card-stats border-start border-info shadow-sm text-center">
                <h6 class="text-muted">Total de Pacientes</h6>
                <h3>{{ pacientes_count }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-stats border-start border-success shadow-sm text-center">
                <h6 class="text-muted">Total de Consultas</h6>
                <h3>{{ consultas_count }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-stats border-start border-warning shadow-sm text-center">
                <h6 class="text-muted">Ansiedad / Pánico</h6>
                <h3>{{ ansiedad_count }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-stats border-start border-danger shadow-sm text-center">
                <h6 class="text-muted">Depresión</h6>
                <h3>{{ depresion_count }}</h3>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-4">
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">
                <h5 class="mb-3 text-center">Pacientes por Sexo</h5>
                <canvas id="sexoChart"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card p-3 shadow-sm">
                <h5 class="mb-3 text-center">Diagnósticos más Comunes</h5>
                <canvas id="diagnosticosChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Scripts de Chart.js -->
<script>
    const ctxSexo = document.getElementById('sexoChart');
    if (ctxSexo) {
        new Chart(ctxSexo, {
            type: 'pie',
            data: {
                labels: {{ sexo_labels|safe }},
                datasets: [{
                    label: 'Pacientes por sexo',
                    data: {{ sexo_data|safe }},
                    backgroundColor: ['#74c0fc', '#63e6be', '#ffd43b'],
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }

    const ctxDiag = document.getElementById('diagnosticosChart');
    if (ctxDiag) {
        new Chart(ctxDiag, {
            type: 'bar',
            data: {
                labels: {{ diag_labels|safe }},
                datasets: [{
                    label: 'Frecuencia',
                    data: {{ diag_data|safe }},
                    backgroundColor: '#339af0'
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }
</script>

</body>
</html>
